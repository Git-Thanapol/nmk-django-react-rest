{% extends 'base.html' %}
{% load static %}

{% block title %}Platform Import{% endblock %}
{% block page_title %}Platform Integration Center{% endblock %}

{% block content %}
<div class="container-fluid p-4">

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi bi-info-circle-fill me-2"></i>{{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row g-4">
        
        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm overflow-hidden">
                <div class="card-header border-0 p-4 text-white d-flex align-items-center justify-content-between" 
                     style="background: linear-gradient(45deg, #000000, #25F4EE, #FE2C55); background-size: 200% 200%;">
                    <div>
                        <h4 class="mb-0 fw-bold"><i class="bi bi-tiktok me-2"></i>TikTok Shop</h4>
                        <small class="opacity-75">Status: <span class="badge bg-success">Active</span></small>
                    </div>
                </div>

                <div class="card-body p-4 d-flex flex-column">
                    <p class="text-muted small mb-4">
                        Import sales orders, calculate fees, and update inventory automatically from TikTok CSV/Excel exports.
                    </p>

                    <form method="post" enctype="multipart/form-data" id="tiktokForm">
                        {% csrf_token %}
                        <input type="hidden" name="platform" value="tiktok">
                        
                        <input type="file" name="import_file" id="tiktokFile" class="d-none" 
                               accept=".csv, .xlsx, .xls" onchange="handleFileSelect(this, 'tiktok')">

                        <div id="tiktok-step-1" class="text-center py-3 border rounded-3 bg-light" 
                             style="border-style: dashed !important; cursor: pointer;"
                             onclick="document.getElementById('tiktokFile').click();">
                            <i class="bi bi-cloud-arrow-up fs-1 text-secondary"></i>
                            <div class="mt-2 fw-medium text-secondary">Click to Select File</div>
                            <small class="text-muted">.csv, .xlsx, .xls supported</small>
                        </div>

                        <div id="tiktok-step-2" class="d-none mt-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded border mb-3 ">
                                <i class="bi bi-file-earmark-spreadsheet text-success fs-3 me-3"></i>
                                <div class="overflow-hidden">
                                    <div class="fw-bold text-truncate text-black" id="tiktok-filename">filename.csv</div>
                                    <small class="text-muted text-black-50" id="tiktok-filesize">0 KB</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="resetForm('tiktok')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>

                            <button type="submit" class="btn btn-dark w-100 py-2 fw-bold">
                                <i class="bi bi-cloud-upload-fill me-2"></i>Confirm & Import
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm overflow-hidden" >
                <div class="card-header border-0 p-4 text-white d-flex align-items-center justify-content-between" 
                     style="background: linear-gradient(135deg, #EE4D2D, #FF7337);">
                    <div>
                        <h4 class="mb-0 fw-bold"><i class="bi bi-bag-fill me-2"></i>Shopee</h4>
                        {% comment %} <small class="opacity-75">Status: <span class="badge bg-secondary">Coming Soon</span></small> {% endcomment %}
                        <small class="opacity-75">Status: <span class="badge bg-success">Active</span></small>
                    </div>
                </div>
                <div class="card-body p-4 d-flex flex-column">
                    <p class="text-muted small mb-4">
                        Integration for Shopee Seller Centre exports. Supports Order and Income reports.
                    </p>
                    <form method="post" enctype="multipart/form-data" id="shopeeForm">
                        {% csrf_token %}
                        <input type="hidden" name="platform" value="shopee">
                        
                        <input type="file" name="import_file" id="shopeeFile" class="d-none" 
                               accept=".csv, .xlsx, .xls" onchange="handleFileSelect(this, 'shopee')">

                        <div id="shopee-step-1" class="text-center py-3 border rounded-3 bg-light" 
                             style="border-style: dashed !important; cursor: pointer;"
                             onclick="document.getElementById('shopeeFile').click();">
                            <i class="bi bi-cloud-arrow-up fs-1 text-secondary"></i>
                            <div class="mt-2 fw-medium text-secondary">Click to Select File</div>
                            <small class="text-muted">.csv, .xlsx, .xls supported</small>
                        </div>

                        <div id="shopee-step-2" class="d-none mt-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded border mb-3">
                                <i class="bi bi-file-earmark-spreadsheet text-success fs-3 me-3"></i>
                                <div class="overflow-hidden">
                                    <div class="fw-bold text-truncate text-black" id="shopee-filename">filename.csv</div>
                                    <small class="text-muted text-black-50" id="shopee-filesize">0 KB</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="resetForm('shopee')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>

                            <button type="submit" class="btn btn-dark w-100 py-2 fw-bold">
                                <i class="bi bi-cloud-upload-fill me-2"></i>Confirm & Import
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm overflow-hidden">
                <div class="card-header border-0 p-4 text-white d-flex align-items-center justify-content-between" 
                     style="background: linear-gradient(135deg, #0f146d, #f53d2d);">
                    <div>
                        <h4 class="mb-0 fw-bold"><i class="bi bi-shop me-2"></i>Lazada</h4>
                        {% comment %} <small class="opacity-75">Status: <span class="badge bg-secondary">Coming Soon</span></small> {% endcomment %}
                        <small class="opacity-75">Status: <span class="badge bg-success">Active</span></small>
                    </div>
                </div>
                <div class="card-body p-4 d-flex flex-column">
                    <p class="text-muted small mb-4">
                        Integration for Lazada Seller Center. Automated reconciliation for payout statements.
                    </p>
                    <form method="post" enctype="multipart/form-data" id="lazadaForm">
                        {% csrf_token %}
                        <input type="hidden" name="platform" value="lazada">
                        
                        <input type="file" name="import_file" id="lazadaFile" class="d-none" 
                               accept=".csv, .xlsx, .xls" onchange="handleFileSelect(this, 'lazada')">

                        <div id="lazada-step-1" class="text-center py-3 border rounded-3 bg-light" 
                             style="border-style: dashed !important; cursor: pointer;"
                             onclick="document.getElementById('lazadaFile').click();">
                            <i class="bi bi-cloud-arrow-up fs-1 text-secondary"></i>
                            <div class="mt-2 fw-medium text-secondary">Click to Select File</div>
                            <small class="text-muted">.csv, .xlsx, .xls supported</small>
                        </div>

                        <div id="lazada-step-2" class="d-none mt-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded border mb-3">
                                <i class="bi bi-file-earmark-spreadsheet text-success fs-3 me-3"></i>
                                <div class="overflow-hidden">
                                    <div class="fw-bold text-truncate text-black" id="lazada-filename">filename.csv</div>
                                    <small class="text-muted text-black-50" id="lazada-filesize">0 KB</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="resetForm('lazada')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>

                            <button type="submit" class="btn btn-dark w-100 py-2 fw-bold">
                                <i class="bi bi-cloud-upload-fill me-2"></i>Confirm & Import
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    /**
     * Handles file selection logic
     * 1. Checks file extension
     * 2. Displays filename and size
     * 3. Hides selector, shows confirm button
     */
    function handleFileSelect(input, platform) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const allowedExtensions = /(\.csv|\.xlsx|\.xls)$/i;
            
            // Validate Extension
            if (!allowedExtensions.exec(file.name)) {
                alert('Invalid file type. Please upload CSV or Excel only.');
                input.value = '';
                return;
            }

            // Update UI
            document.getElementById(platform + '-step-1').classList.add('d-none');
            document.getElementById(platform + '-step-2').classList.remove('d-none');
            
            document.getElementById(platform + '-filename').textContent = file.name;
            document.getElementById(platform + '-filesize').textContent = (file.size / 1024).toFixed(2) + ' KB';
        }
    }

    /**
     * Resets the form if user clicks 'X'
     */
    function resetForm(platform) {
        const input = document.getElementById(platform + 'File');
        input.value = ''; // Clear file input
        
        document.getElementById(platform + '-step-1').classList.remove('d-none');
        document.getElementById(platform + '-step-2').classList.add('d-none');
    }
</script>

{% endblock %}