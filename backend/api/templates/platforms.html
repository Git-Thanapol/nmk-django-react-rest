{% extends 'base.html' %}
{% load static %}

{% block title %}Platform Import{% endblock %}
{% block page_title %}Platform Integration Center{% endblock %}

{% block content %}
<div class="container-fluid p-4">

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi bi-info-circle-fill me-2"></i>{{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
    
        <div id="processingToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-cloud-upload me-2"></i>
                    <strong>Uploading & Processing...</strong>
                    <div class="small mt-1">Please wait, do not close this page.</div>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>

    </div>

    <div class="row g-4">
        
        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm overflow-hidden">
                <div class="card-header border-0 p-4 text-white d-flex align-items-center justify-content-between" 
                     style="background: linear-gradient(45deg, #000000, #25F4EE, #FE2C55); background-size: 200% 200%;">
                    <div>
                        <h4 class="mb-0 fw-bold"><i class="bi bi-tiktok me-2"></i>TikTok Shop</h4>
                        <small class="opacity-75">Status: <span class="badge bg-success">Active</span></small>
                    </div>
                </div>

                <div class="card-body p-4 d-flex flex-column">
                    <p class="text-muted small mb-4">
                        นำเข้าคำสั่งขาย คำนวณค่าธรรมเนียม และอัปเดตสต็อกสินค้าโดยอัตโนมัติจากไฟล์ TikTok Shop
                    </p>

                    <form method="post" enctype="multipart/form-data" id="tiktokForm">
                        {% csrf_token %}
                        <input type="hidden" name="platform" value="tiktok">
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-secondary">Import to Company / นำเข้าบริษัท</label>
                            <select name="company_id" class="form-select form-select-sm" required>
                                <option value="" disabled selected>-- เลือกบริษัท --</option>
                                {% for company in companies %}
                                    <option value="{{ company.id }}">{{ company.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <input type="file" name="import_file" id="tiktokFile" class="d-none" 
                               accept=".csv, .xlsx, .xls" onchange="handleFileSelect(this, 'tiktok')">

                        <div id="tiktok-step-1" class="text-center py-3 border rounded-3 bg-light" 
                             style="border-style: dashed !important; cursor: pointer;"
                             onclick="document.getElementById('tiktokFile').click();">
                            <i class="bi bi-cloud-arrow-up fs-1 text-secondary"></i>
                            <div class="mt-2 fw-medium text-secondary">คลิกเพื่อเลือกไฟล์</div>
                        </div>

                        <div id="tiktok-step-2" class="d-none mt-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded border mb-3 ">
                                <i class="bi bi-file-earmark-spreadsheet text-success fs-3 me-3"></i>
                                <div class="overflow-hidden">
                                    <div class="fw-bold text-truncate text-black" id="tiktok-filename">filename.csv</div>
                                    <small class="text-muted text-black-50" id="tiktok-filesize">0 KB</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="resetForm('tiktok')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>

                            {% comment %} <button type="submit" class="btn btn-dark w-100 py-2 fw-bold">
                                <i class="bi bi-cloud-upload-fill me-2"></i>Confirm & Import
                            </button> {% endcomment %}
                            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                                <i class="bi bi-cloud-upload-fill me-2"></i> นำเข้าข้อมูล 
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm overflow-hidden" >
                <div class="card-header border-0 p-4 text-white d-flex align-items-center justify-content-between" 
                     style="background: linear-gradient(135deg, #EE4D2D, #FF7337);">
                    <div>
                        <h4 class="mb-0 fw-bold"><i class="bi bi-bag-fill me-2"></i>Shopee</h4>
                        <small class="opacity-75">Status: <span class="badge bg-success">Active</span></small>
                    </div>
                </div>
                <div class="card-body p-4 d-flex flex-column">
                    <p class="text-muted small mb-4">
                        เชื่อมต่อการนำเข้าข้อมูลจาก Shopee Seller Centre รองรับรายงานคำสั่งซื้อ
                    </p>
                    <form method="post" enctype="multipart/form-data" id="shopeeForm">
                        {% csrf_token %}
                        <input type="hidden" name="platform" value="shopee">
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-secondary">Import to Company / นำเข้าบริษัท</label>
                            <select name="company_id" class="form-select form-select-sm" required>
                                <option value="" disabled selected>-- เลือกบริษัท --</option>
                                {% for company in companies %}
                                    <option value="{{ company.id }}">{{ company.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <input type="file" name="import_file" id="shopeeFile" class="d-none" 
                               accept=".csv, .xlsx, .xls" onchange="handleFileSelect(this, 'shopee')">

                        <div id="shopee-step-1" class="text-center py-3 border rounded-3 bg-light" 
                             style="border-style: dashed !important; cursor: pointer;"
                             onclick="document.getElementById('shopeeFile').click();">
                            <i class="bi bi-cloud-arrow-up fs-1 text-secondary"></i>
                            <div class="mt-2 fw-medium text-secondary">คลิกเพื่อเลือกไฟล์</div>
                        </div>

                        <div id="shopee-step-2" class="d-none mt-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded border mb-3">
                                <i class="bi bi-file-earmark-spreadsheet text-success fs-3 me-3"></i>
                                <div class="overflow-hidden">
                                    <div class="fw-bold text-truncate text-black" id="shopee-filename">filename.csv</div>
                                    <small class="text-muted text-black-50" id="shopee-filesize">0 KB</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="resetForm('shopee')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>

                            {% comment %} <button type="submit" class="btn btn-dark w-100 py-2 fw-bold">
                                <i class="bi bi-cloud-upload-fill me-2"></i>Confirm & Import
                            </button> {% endcomment %}
                            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                                <i class="bi bi-cloud-upload-fill me-2"></i> นำเข้าข้อมูล 
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm overflow-hidden">
                <div class="card-header border-0 p-4 text-white d-flex align-items-center justify-content-between" 
                     style="background: linear-gradient(135deg, #0f146d, #f53d2d);">
                    <div>
                        <h4 class="mb-0 fw-bold"><i class="bi bi-shop me-2"></i>Lazada</h4>
                        <small class="opacity-75">Status: <span class="badge bg-success">Active</span></small>
                    </div>
                </div>
                <div class="card-body p-4 d-flex flex-column">
                    <p class="text-muted small mb-4">
                        เชื่อมต่อการนำเข้าข้อมูลจาก Lazada Seller Center รองรับรายงานคำสั่งซื้อ
                    </p>
                    <form method="post" enctype="multipart/form-data" id="lazadaForm">
                        {% csrf_token %}
                        <input type="hidden" name="platform" value="lazada">
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-secondary">Import to Company / นำเข้าบริษัท</label>
                            <select name="company_id" class="form-select form-select-sm" required>
                                <option value="" disabled selected>-- เลือกบริษัท --</option>
                                {% for company in companies %}
                                    <option value="{{ company.id }}">{{ company.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <input type="file" name="import_file" id="lazadaFile" class="d-none" 
                               accept=".csv, .xlsx, .xls" onchange="handleFileSelect(this, 'lazada')">

                        <div id="lazada-step-1" class="text-center py-3 border rounded-3 bg-light" 
                             style="border-style: dashed !important; cursor: pointer;"
                             onclick="document.getElementById('lazadaFile').click();">
                            <i class="bi bi-cloud-arrow-up fs-1 text-secondary"></i>
                            <div class="mt-2 fw-medium text-secondary">คลิกเพื่อเลือกไฟล์</div>
                        </div>

                        <div id="lazada-step-2" class="d-none mt-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded border mb-3">
                                <i class="bi bi-file-earmark-spreadsheet text-success fs-3 me-3"></i>
                                <div class="overflow-hidden">
                                    <div class="fw-bold text-truncate text-black" id="lazada-filename">filename.csv</div>
                                    <small class="text-muted text-black-50" id="lazada-filesize">0 KB</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="resetForm('lazada')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>

                            {% comment %} <button type="submit" class="btn btn-dark w-100 py-2 fw-bold">
                                <i class="bi bi-cloud-upload-fill me-2"></i>Confirm & Import
                            </button> {% endcomment %}
                            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                                <i class="bi bi-cloud-upload-fill me-2"></i> นำเข้าข้อมูล 
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

<hr class="my-5">

<div class="card shadow-sm">
    <div class="card-header bg-dark d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Import History</h5>
        <a href="{% url 'platform_import' %}" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-arrow-clockwise"></i> Refresh Status
        </a>
    </div>
    <div class="card-body p-0">
        <table class="table table-striped mb-0">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Platform</th>
                    <th>File</th>
                    <th>Status</th>
                    <th>Result</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for log in import_history %}
                <tr>
                    <td>{{ log.created_at|date:"d/m/Y H:i" }}</td>
                    <td><span class="badge bg-secondary">{{ log.platform }}</span></td>
                    <td>{{ log.filename }}</td>
                    <td>
                        {% if log.status == 'PENDING' or log.status == 'PROCESSING' %}
                            <span class="badge bg-warning text-dark">
                                <span class="spinner-border spinner-border-sm" style="width: 0.7rem; height: 0.7rem;"></span>
                                {{ log.get_status_display }}
                            </span>
                        {% elif log.status == 'COMPLETED' %}
                            <span class="badge bg-success">Success</span>
                        {% elif log.status == 'COMPLETED_WITH_ERRORS' %}
                            <span class="badge bg-danger">Has Errors</span>
                        {% else %}
                            <span class="badge bg-dark">Failed</span>
                        {% endif %}
                    </td>
                    <td>
                        <small>
                            Success: {{ log.success_count }} <br>
                            Failed: {{ log.failed_count }}
                        </small>
                    </td>
                    <td>
                        {% if log.error_file %}
                            <a href="{{ log.error_file.url }}" class="btn btn-sm btn-danger">
                                <i class="bi bi-download"></i> Error Report
                            </a>
                        {% elif log.status == 'COMPLETED' %}
                            <i class="bi bi-check-circle-fill text-success fs-5"></i>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-4 text-muted">No import history found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function handleFileSelect(input, platform) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const allowedExtensions = /(\.csv|\.xlsx|\.xls)$/i;
            
            if (!allowedExtensions.exec(file.name)) {
                alert('Invalid file type. Please upload CSV or Excel only.');
                input.value = '';
                return;
            }

            document.getElementById(platform + '-step-1').classList.add('d-none');
            document.getElementById(platform + '-step-2').classList.remove('d-none');
            
            document.getElementById(platform + '-filename').textContent = file.name;
            document.getElementById(platform + '-filesize').textContent = (file.size / 1024).toFixed(2) + ' KB';
        }
    }

    function resetForm(platform) {
        const input = document.getElementById(platform + 'File');
        input.value = ''; 
        
        document.getElementById(platform + '-step-1').classList.remove('d-none');
        document.getElementById(platform + '-step-2').classList.add('d-none');
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const importForm = document.querySelector('form[enctype="multipart/form-data"]'); // Select your import form
        
        if (importForm) {
            importForm.addEventListener('submit', function(e) {
                // 1. Check if form is valid (let browser handle 'required' fields first)
                if (!importForm.checkValidity()) {
                    return; // Stop if validation fails
                }

                const submitBtn = importForm.querySelector('button[type="submit"]');
                
                // 2. Disable Button & Show Spinner
                if (submitBtn) {
                    submitBtn.disabled = true;
                    // Save original text to restore if needed (though page usually reloads)
                    submitBtn.dataset.originalText = submitBtn.innerHTML; 
                    submitBtn.innerHTML = `
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Processing...
                    `;
                }

                // 3. Show "Processing" Toast
                const toastEl = document.getElementById('processingToast');
                if (toastEl) {
                    const toast = new bootstrap.Toast(toastEl, { delay: 10000 }); // Show for 10s or until reload
                    toast.show();
                }

                // NOTE: 
                // If the server returns a SUCCESS redirect, the page reloads, and this state resets automatically.
                // If the server returns an ERROR FILE (download), the page DOES NOT reload.
                // The button will remain disabled to prevent double-clicking while the file downloads.
                // The user must refresh the page to try again, which is good practice (they need to fix the file first).
            });
        }
    });
</script>

{% endblock %}