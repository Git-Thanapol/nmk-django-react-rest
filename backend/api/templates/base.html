{% load static %}
<!DOCTYPE html>
<html lang="th" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NAMKANG • {% block title %}Accounting System{% endblock %}</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <link href="{% static 'css/style.css' %}" rel="stylesheet" />
    <link rel="shortcut icon" type="image/png" href="{% static 'favicon.png' %}"/>
  </head>

  <body>
    <button class="menu-toggle" id="menuToggle" aria-label="Open Sidebar">
      <i class="bi bi-list"></i>
    </button>

    <div class="app">
      
      <aside class="sidebar p-3 d-flex flex-column">
        <button class="sidebar-close" id="sidebarClose" aria-label="Close Sidebar">
          <i class="bi bi-x-lg"></i>
        </button>

        <div class="d-flex align-items-center gap-2 mb-4">
          <div class="brand h5 mb-0">Namkang Phone</div>
        </div>

        <div class="d-flex align-items-center gap-2 mb-4">
          <img
            class="avatar"
            src="https://ui-avatars.com/api/?name={{ user.username|default:'Admin' }}&background=3b5998&color=ffffff&size=128&rounded=true"
            alt="User Avatar"
          />
          
          <div>
            {% if user.is_authenticated %}
                <div class="fw-semibold">{{ user.username }}</div>
                <div class="muted small">Administrator</div>
            {% else %}
                <div class="fw-semibold">Guest</div>
                <div class="muted small">Please Login</div>
            {% endif %}
          </div>
        </div>

        <hr />

        <nav class="nav nav-pills flex-column gap-1">
          <a
            class="nav-link {% if request.path == '/purchase_list/' %}active{% endif %}"
            href="{% url 'purchase_list' %}"
          >
            <i class="bi bi-cart me-2"></i>รายการซื้อเข้า
          </a>
          
          <a
            class="nav-link {% if request.path == '/invoice_list/' %}active{% endif %}"
            href="{% url 'invoice_list' %}"
          >
            <i class="bi bi-receipt me-2"></i>รายการขาย
          </a>

          <a
            class="nav-link {% if request.path == '/transaction_list/' %}active{% endif %}"
            href="{% url 'transaction_list' %}"
          >
            <i class="bi bi-graph-up me-2"></i>ค่าใช้จ่ายอื่นๆ
          </a>

          <a 
            class="nav-link {% if request.path == '/customer_list/' %}active{% endif %}"
            href="{% url 'customer_list' %}"
          >
            <i class="bi bi-file-person-fill me-2"></i>ผู้ซื้อ
          </a>          

          <a 
            class="nav-link {% if request.path == '/vendor_list/' %}active{% endif %}"
            href="{% url 'vendor_list' %}"
          >
            <i class="bi bi-person-lines-fill me-2"></i>ผู้ขาย
          </a>
          
          <a 
            class="nav-link {% if request.path == '/product_list/' %}active{% endif %}"
            href="{% url 'product_list' %}"
          >
            <i class="bi bi-phone me-2"></i>สินค้าและบริการ
          </a>

            <a 
            class="nav-link {% if request.path == '/admin/' %}active{% endif %}"
            href="{% url 'admin:index' %}"
          >
            <i class="bi bi-gear me-2"></i>Administrator Settings
          </a>

          <a 
            class="nav-link {% if request.path == '/import/platforms/' %}active{% endif %}"
            href="{% url 'platform_import' %}"
          >
            <i class="bi bi-layers me-2"></i>Platforms
          </a>

          <a 
            class="nav-link {% if request.path == '/product_mapping/' %}active{% endif %}"
            href="{% url 'product_mapping' %}"
          >
            <i class="bi bi-layers me-2"></i>Product Mapping
          </a>

          <hr />

          <a class="nav-link {% if request.path == '/help/' %}active{% endif %}"
             href="{% url 'help' %}">
            <i class="bi bi-question-circle me-2"></i>Help
          </a>

          <a
            class="nav-link text-danger"
            href="{% url 'logout' %}"
            onclick="return confirm('ต้องการออกจากระบบหรือไม่?');"
          >
            <i class="bi bi-box-arrow-right me-2"></i>ออกจากระบบ
          </a>
        </nav>
      </aside>

      <main class="d-flex flex-column">
        <div class="topbar d-flex align-items-center justify-content-between px-4 py-3">
          <div class="h5 mb-0">
            {% block page_title %}Dashboard{% endblock %}
          </div>
        </div>

        <div class="content">
          {% block content %} 
            {% endblock %}
        </div>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        
        // --- 1. Sidebar Toggle Logic (Mobile) ---
        const menuToggle = document.getElementById("menuToggle");
        const sidebarClose = document.getElementById("sidebarClose");
        const sidebar = document.querySelector(".sidebar");

        if (menuToggle && sidebar) {
            menuToggle.addEventListener("click", () => sidebar.classList.add("show"));
        }

        if (sidebarClose && sidebar) {
            sidebarClose.addEventListener("click", () => sidebar.classList.remove("show"));
        }

        // Close sidebar when clicking outside (on mobile overlay)
        document.addEventListener("click", function (event) {
          if (window.innerWidth <= 992 && sidebar.classList.contains("show")) {
            if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
              sidebar.classList.remove("show");
            }
          }
        });

        // --- 2. Auto-Calculation Logic ---
        // Looks for inputs with specific classes to calculate totals dynamically
        // Use logic 'if(row)' to prevent errors on pages where this table doesn't exist
        const inputs = document.querySelectorAll(".qty, .price, .discount");
        
        if (inputs.length > 0) {
            inputs.forEach((input) => {
                input.addEventListener("input", calculateLineTotal);
            });
        }

        function calculateLineTotal() {
          const row = this.closest("tr");
          if (!row) return; // Safety check

          const qty = parseFloat(row.querySelector(".qty")?.value) || 0;
          const price = parseFloat(row.querySelector(".price")?.value) || 0;
          const discount = parseFloat(row.querySelector(".discount")?.value) || 0;

          const lineTotal = (qty * price) - discount;
          
          const totalElement = row.querySelector(".line-total");
          if (totalElement) {
              totalElement.textContent = lineTotal.toFixed(2);
          }
        }
      });
    </script>
  </body>
</html>